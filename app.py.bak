#!/usr/bin/env python3
import json
import os
from datetime import datetime, timedelta
import sys

'''
json file handler
'''
class JSONStore:
    def __init__(self, filename="eod_data.json"):
        self.filename = filename
        self.data = self.load_data()

    '''
    loads the json file
    '''
    def load_data(self):
        if os.path.exists(self.filename):
            try:
                with open(self.filename, 'r') as f:
                    return json.load(f)
            except (json.JSONDecodeError, FileNotFoundError):
                return self.get_default_data()
        return self.get_default_data()

    '''
    parser
    '''
    def get_default_data(self):
        return {
            "blockers": [],
            "current_blocker": None,
            "last_updated": None,
            "session_info": None,
            "tickets": [],
            "notes": []
        }
    '''
    writes to file
    '''
    def save_data(self):
        with open(self.filename, 'w') as f:
            json.dump(self.data, f, indent=2)

'''
eod runner
'''
class EODTracker:
    def __init__(self):
        self.store = JSONStore()
        self.check_recovery()

    '''
    initialization prompt for session info
    '''
    def prompt_session_info(self):
        print("\n" + "="*60)
        print("SESSION INITIALIZATION")
        print("="*60)
        print("Please provide the following information:")
        
        pack_number = input("Pack Number: ").strip()
        key_used = input("Key Used: ").strip()
        glove_number = input("Glove #: ").strip()
        dongle_number = input("Dongle #: ").strip()
        phone_id = input("Phone ID: ").strip()
        tickets = []
        
        
        
        session_info = {
            "pack_number": pack_number,
            "key_used": key_used,
            "glove_number": glove_number,
            "dongle_number": dongle_number,
            "phone_id": phone_id,
            "date": datetime.now().strftime("%Y-%m-%d"),
            "initialized_at": self.format_timestamp()
        }
        
        self.store.data["session_info"] = session_info
        self.store.data["tickets"] = tickets
        self.store.save_data()
        
        print("\n✅ Session information saved!")
        if tickets:
            print(f"📋 Tickets recorded: {', '.join(tickets)}")

    '''
    add ticket numbers to current blocker
    '''
    def add_ticket(self):
        if not self.store.data.get("current_blocker"):
            print("❌ No active blocker. Start a blocker first to add tickets.")
            return
        
        current = self.store.data["current_blocker"]
        
        # Initialize tickets list for current blocker if it doesn't exist
        if "tickets" not in current:
            current["tickets"] = []
        
        # Show existing tickets if any
        if current["tickets"]:
            print(f"Current tickets: {', '.join(current['tickets'])}")
        
        ticket = input("Enter ticket number: ").strip()
        if ticket:
            # Add to current blocker's tickets
            current["tickets"].append(ticket)
            
            # Add to global tickets list
            if "tickets" not in self.store.data:
                self.store.data["tickets"] = []
            self.store.data["tickets"].append(ticket)
            
            self.store.save_data()
            print(f"✅ Ticket {ticket} added to current blocker!")
            print(f"📋 All tickets for this blocker: {', '.join(current['tickets'])}")
        else:
            print("❌ Ticket number cannot be empty.")

    '''
    add notes to current blocker
    '''
    def add_note(self):
        if not self.store.data.get("current_blocker"):
            print("❌ No active blocker. Start a blocker first to add notes.")
            return
        
        print("\n" + "="*50)
        print("ADD NOTE TO CURRENT BLOCKER")
        print("="*50)
        current = self.store.data["current_blocker"]
        print(f"Current blocker: {current['description']}")
        print("Enter your note (press Enter twice to finish):")
        
        lines = []
        while True:
            line = input()
            if line == "" and len(lines) > 0:
                break
            lines.append(line)
        
        if not lines or all(line.strip() == "" for line in lines):
            return
        
        note_content = "\n".join(lines).strip()
        
        # Add note to current blocker
        if "notes" not in self.store.data["current_blocker"]:
            self.store.data["current_blocker"]["notes"] = []
        
        note = {
            "content": note_content,
            "timestamp": self.format_timestamp()
        }
        
        self.store.data["current_blocker"]["notes"].append(note)
        self.store.save_data()
        
        print(f"\n✅ Note added to current blocker at {note['timestamp']}")
        print(f"📝 Preview: {note_content[:50]}{'...' if len(note_content) > 50 else ''}")

    '''
    recovery
    '''
    def check_recovery(self):
        if self.store.data.get("current_blocker"):
            print(f"= Recovered session with active blocker: '{self.store.data['current_blocker']['description']}'")
            print(f"   Started at: {self.store.data['current_blocker']['start_time']}")

    '''
    timestamps
    '''
    def format_timestamp(self, dt=None):
        if dt is None:
            dt = datetime.now()
        return dt.strftime("%Y-%m-%d %H:%M:%S")
    
    def parse_timestamp(self, ts_string):
        return datetime.strptime(ts_string, "%Y-%m-%d %H:%M:%S")



    '''
    blocker report
    '''
    def start_blocker(self, description):
        if self.store.data.get("current_blocker"):
            print("�  A blocker is already active. Please end it first.")
            return False
        
        # Ask if they want to add a ticket number
        ticket_response = input("Do you want to add a ticket number for this blocker? (y/n): ").strip().lower()
        tickets = []
        
        if ticket_response in ['y', 'yes']:
            ticket_number = input("Enter ticket number: ").strip()
            if ticket_number:
                tickets.append(ticket_number)
                if "tickets" not in self.store.data:
                    self.store.data["tickets"] = []
                self.store.data["tickets"].append(ticket_number)
        
        current_blocker = {
            "description": description,
            "start_time": self.format_timestamp(),
            "tickets": tickets
        }
        
        self.store.data["current_blocker"] = current_blocker
        self.store.data["last_updated"] = self.format_timestamp()
        self.store.save_data()
        
        ticket_info = f" (Tickets: {', '.join(tickets)})" if tickets else ""
        print(f"🚫 Started blocker: '{description}'{ticket_info} at {current_blocker['start_time']}")
        return True
    '''
    resolving blockers
    '''
    def end_current_blocker(self):
        current = self.store.data.get("current_blocker")
        if not current:
            print("L No active blocker to end.")
            return False
        
        end_time = self.format_timestamp()
        start_dt = self.parse_timestamp(current["start_time"])
        end_dt = self.parse_timestamp(end_time)
        duration = end_dt - start_dt
        
        completed_blocker = {
            "description": current["description"],
            "start_time": current["start_time"],
            "end_time": end_time,
            "duration_minutes": int(duration.total_seconds() / 60),
            "tickets": current.get("tickets", []),
            "notes": current.get("notes", [])
        }
        
        self.store.data["blockers"].append(completed_blocker)
        self.store.data["current_blocker"] = None
        self.store.data["last_updated"] = self.format_timestamp()
        self.store.save_data()
        
        hours = completed_blocker["duration_minutes"] // 60
        minutes = completed_blocker["duration_minutes"] % 60
        
        print(f" Ended blocker: '{current['description']}'")
        print(f"   Duration: {hours}h {minutes}m ({completed_blocker['duration_minutes']} minutes)")
        return True

    '''
    summary view of todays blocker
    '''
    def view_today_summary(self):
        today = datetime.now().strftime("%Y-%m-%d")
        today_blockers = [b for b in self.store.data["blockers"] if b["start_time"].startswith(today)]
        
        print(f"\nToday's Summary ({today})")
        print("=" * 40)
        
        if not today_blockers and not self.store.data.get("current_blocker"):
            print("No blockers recorded today.")
            return
        
        total_minutes = 0
        
        for i, blocker in enumerate(today_blockers, 1):
            hours = blocker["duration_minutes"] // 60
            minutes = blocker["duration_minutes"] % 60
            print(f"{i}. {blocker['description']}")
            print(f"   {blocker['start_time']} � {blocker['end_time']} ({hours}h {minutes}m)")
            total_minutes += blocker["duration_minutes"]
        
        if self.store.data.get("current_blocker"):
            current = self.store.data["current_blocker"]
            start_dt = self.parse_timestamp(current["start_time"])
            current_duration = datetime.now() - start_dt
            current_minutes = int(current_duration.total_seconds() / 60)
            
            print(f"= ACTIVE: {current['description']}")
            print(f"   Started: {current['start_time']} (running {current_minutes} minutes)")
            total_minutes += current_minutes
        
        total_hours = total_minutes // 60
        remaining_minutes = total_minutes % 60
        
        print(f"\n�  Total blocker time today: {total_hours}h {remaining_minutes}m ({total_minutes} minutes)")
    '''
    end of day generator
    '''
    def generate_eod_report(self):
        today = datetime.now().strftime("%Y-%m-%d")
        today_blockers = [b for b in self.store.data["blockers"] if b["start_time"].startswith(today)]
        
        print(f"\n=� End of Day Report - {today}")
        print("=" * 50)
        
        if not today_blockers:
            print("No blockers encountered today!")
            return
        
        total_minutes = sum(b["duration_minutes"] for b in today_blockers)
        total_hours = total_minutes // 60
        remaining_minutes = total_minutes % 60
        
        print(f"=� Blockers encountered: {len(today_blockers)}")
        print(f"�  Total time blocked: {total_hours}h {remaining_minutes}m")
        print("\nDetailed breakdown:")
        
        for i, blocker in enumerate(today_blockers, 1):
            hours = blocker["duration_minutes"] // 60
            minutes = blocker["duration_minutes"] % 60
            print(f"  {i}. {blocker['description']}")
            print(f"     Time: {blocker['start_time']} � {blocker['end_time']}")
            print(f"     Duration: {hours}h {minutes}m")
        
        if self.store.data.get("current_blocker"):
            print(f"\n�  Warning: Active blocker still running: '{self.store.data['current_blocker']['description']}'")
    '''
    reset
    '''
    def clear_all_data(self):
        confirm = input("=�  Are you sure you want to clear ALL data? This cannot be undone. (type 'YES' to confirm): ")
        if confirm == "YES":
            self.store.data = self.store.get_default_data()
            self.store.save_data()
            print(" All data cleared successfully.")
        else:
            print("L Clear operation cancelled.")
    '''
    menue interface
    '''
    def show_menu(self):
        print("\n" + "="*50)
        print("📋 EOD GENERATOR - End of Day Report Tool")
        print("="*50)
        print("1. Start new blocker")
        print("2. End current blocker")
        print("3. View today's summary")
        print("4. Generate EOD report")
        print("5. Clear all data")
        print("6. Exit")
        
        # Show notes and tickets options only if there's an active blocker
        if self.store.data.get("current_blocker"):
            print("7. Add note to current blocker")
            print("8. Add ticket to current blocker")
        
        print("-" * 50)
    
    def run(self):
        print("EOD Generator Started")
        
        while True:
            self.show_menu()
            max_choice = 8 if self.store.data.get("current_blocker") else 6
            choice = input(f"Select an option (1-{max_choice}): ").strip()
            
            if choice == "1":
                if self.store.data.get("current_blocker"):
                    print("�  A blocker is already active:")
                    current = self.store.data["current_blocker"]
                    print(f"   '{current['description']}' started at {current['start_time']}")
                    print("   Please end it first before starting a new one.")
                else:
                    description = input("Enter blocker description: ").strip()
                    if description:
                        self.start_blocker(description)
                    else:
                        print("L Description cannot be empty.")
            
            elif choice == "2":
                self.end_current_blocker()
            
            elif choice == "3":
                self.view_today_summary()
            
            elif choice == "4":
                self.generate_eod_report()
            
            elif choice == "5":
                self.clear_all_data()
            
            elif choice == "6":
                if self.store.data.get("current_blocker"):
                    print("⚠️  You have an active blocker. It will be preserved for next session.")
                print("👋 Goodbye! Your data has been saved.")
                break
            
            elif choice == "7" and self.store.data.get("current_blocker"):
                self.add_note()
            
            elif choice == "8" and self.store.data.get("current_blocker"):
                self.add_ticket()
            
            else:
                max_choice = 8 if self.store.data.get("current_blocker") else 6
                print(f"❌ Invalid choice. Please select 1-{max_choice}.")

if __name__ == "__main__":
    try:
        tracker = EODTracker()
        tracker.run()
    except KeyboardInterrupt:
        print("\n\n⚠️  Session interrupted. Your data has been saved.")
        sys.exit(0)
    except Exception as e:
        print(f"\n❌ An error occurred: {e}")
        sys.exit(1)


'''
# need to fix menue  1-8 add notes and tickets should be option 7 and 8

# review initialization
# review recovery
# review json structure
'''
